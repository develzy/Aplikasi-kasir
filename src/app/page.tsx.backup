"use client";

import { useEffect, useState } from "react";
import {
  TrendingUp,
  TrendingDown,
  Wallet,
  ShoppingBag,
  ArrowUpRight,
  ArrowDownLeft,
  Search,
  Bell
} from "lucide-react";
import StatsCard from "@/components/StatsCard";
import {
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  AreaChart,
  Area,
  XAxis,
  YAxis
} from 'recharts';

interface Transaction {
  id: number;
  type: 'income' | 'expense';
  category: string;
  amount: number;
  date: string;
  note: string;
}

interface Stats {
  balance: number;
  income: number;
  expense: number;
  transactionCount: number;
}

export default function Dashboard() {
  const [stats, setStats] = useState<Stats>({ balance: 0, income: 0, expense: 0, transactionCount: 0 });
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [statsRes, transRes] = await Promise.all([
          fetch('/api/stats'),
          fetch('/api/transactions')
        ]);
        const statsData = await statsRes.json() as Stats;
        const transData = await transRes.json() as Transaction[];

        setStats(statsData);
        setTransactions(transData.slice(0, 5)); // Latest 5
        setLoading(false);
      } catch (err) {
        console.error("Failed to fetch dashboard data:", err);
        setLoading(false);
      }
    };
    fetchData();
  }, []);

  return (
    <div className="container">
      <header className="dashboard-header">
        <div>
          <h1 style={{ fontSize: '2rem', marginBottom: '0.25rem' }}>Selamat Datang, Admin</h1>
          <p style={{ color: 'var(--text-muted)' }}>Pantau performa keuangan bisnis Anda hari ini.</p>
        </div>
        <div className="dashboard-actions">
          <div style={{
            position: 'relative',
            background: 'var(--card-bg)',
            padding: '0.5rem 1rem',
            borderRadius: 'var(--radius-md)',
            border: '1px solid var(--card-border)',
            display: 'flex',
            alignItems: 'center',
            gap: '0.5rem',
            width: '300px'
          }}>
            <Search size={18} color="var(--text-muted)" />
            <input
              type="text"
              placeholder="Cari transaksi..."
              style={{ background: 'none', border: 'none', color: '#fff', outline: 'none', width: '100%' }}
            />
          </div>
          <button className="card" style={{
            padding: '0.75rem',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            position: 'relative'
          }}>
            <Bell size={20} />
            <span style={{
              position: 'absolute',
              top: '0.5rem',
              right: '0.5rem',
              width: '8px',
              height: '8px',
              background: 'var(--danger)',
              borderRadius: '50%'
            }}></span>
          </button>
        </div>
      </header>

      <style jsx>{`
        .dashboard-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 2rem;
        }
        .dashboard-actions {
          display: flex;
          gap: 1rem;
          align-items: center;
        }
        @media (max-width: 768px) {
          .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
          }
          .dashboard-actions {
            display: none;
          }
        }
      </style>

      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))', gap: '1.5rem', marginBottom: '2rem' }}>
        <StatsCard
          label="Total Saldo"
          value={`Rp ${stats.balance.toLocaleString('id-ID')}`}
          icon={Wallet}
          color="var(--primary)"
        />
        <StatsCard
          label="Pemasukan (Total)"
          value={`Rp ${stats.income.toLocaleString('id-ID')}`}
          icon={TrendingUp}
          color="var(--success)"
        />
        <StatsCard
          label="Pengeluaran (Total)"
          value={`Rp ${stats.expense.toLocaleString('id-ID')}`}
          icon={TrendingDown}
          color="var(--danger)"
        />
        <StatsCard
          label="Total Transaksi"
          value={stats.transactionCount.toString()}
          icon={ShoppingBag}
          color="var(--warning)"
        />
      </div>

      <div className="grid-responsive" style={{ display: 'grid', gap: '1.5rem' }}>
        <div className="card" style={{ height: '400px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1.5rem' }}>
            <h3 style={{ fontSize: '1.25rem' }}>Arus Kas</h3>
            <div style={{ display: 'flex', gap: '0.5rem' }}>
              <span className="badge badge-success">Siklus Keuangan</span>
            </div>
          </div>
          <div style={{ width: '100%', height: '300px' }}>
            <ResponsiveContainer width="100%" height="100%">
              <AreaChart data={[]}> {/* Could be populated with real monthly data if needed */}
                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" vertical={false} />
                <Tooltip
                  contentStyle={{ background: '#1e293b', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px' }}
                  itemStyle={{ color: '#fff' }}
                />
                <Area type="monotone" dataKey="amount" stroke="var(--primary)" fillOpacity={0.1} fill="var(--primary)" />
              </AreaChart>
            </ResponsiveContainer>
            <div style={{ textAlign: 'center', color: 'var(--text-muted)', fontSize: '0.85rem', marginTop: '4rem' }}>
              Data grafik akan terisi seiring bertambahnya transaksi.
            </div>
          </div>
        </div>

        <div className="card">
          <h3 style={{ fontSize: '1.25rem', marginBottom: '1.5rem' }}>Transaksi Terakhir</h3>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
            {loading ? (
              <div style={{ color: 'var(--text-muted)' }}>Memuat...</div>
            ) : transactions.length === 0 ? (
              <div style={{ color: 'var(--text-muted)' }}>Belum ada transaksi.</div>
            ) : (
              transactions.map((tx) => (
                <div key={tx.id} style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  padding: '0.75rem',
                  borderRadius: 'var(--radius-md)',
                  background: 'rgba(255,255,255,0.02)'
                }}>
                  <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                    <div style={{
                      width: '36px',
                      height: '36px',
                      borderRadius: '50%',
                      background: tx.type === 'income' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(244, 63, 94, 0.1)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      color: tx.type === 'income' ? 'var(--success)' : 'var(--danger)'
                    }}>
                      {tx.type === 'income' ? <ArrowUpRight size={18} /> : <ArrowDownLeft size={18} />}
                    </div>
                    <div>
                      <div style={{ fontWeight: '600', fontSize: '0.9rem' }}>{tx.category}</div>
                      <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>{tx.date}</div>
                    </div>
                  </div>
                  <div style={{
                    fontWeight: '700',
                    color: tx.type === 'income' ? 'var(--success)' : 'var(--danger)',
                    fontSize: '0.9rem'
                  }}>
                    {tx.type === 'income' ? '+' : '-'} Rp {tx.amount.toLocaleString('id-ID')}
                  </div>
                </div>
              ))
            )}
          </div>
          <button style={{
            width: '100%',
            marginTop: '1.5rem',
            padding: '0.75rem',
            textAlign: 'center',
            color: 'var(--primary)',
            fontWeight: '600',
            fontSize: '0.9rem',
            border: '1px dashed var(--card-border)',
            borderRadius: 'var(--radius-md)',
            background: 'none',
            cursor: 'pointer'
          }}>
            Lihat Semua Transaksi
          </button>
        </div>
      </div>

      <style jsx>{`
        .grid-responsive {
          grid-template-columns: 2fr 1fr;
        }
        @media (max-width: 1023px) {
          .grid-responsive {
            grid-template-columns: 1fr;
          }
        }
      `}</style>
    </div >
  );
}
